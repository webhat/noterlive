<!DOCTYPE html>
<html>
<head><title>Noter Live</title>
    <meta charset="utf-8">
    <link href="bootstrap.css" media="all" rel="stylesheet" type="text/css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="twitter:site" content="@webhat">

    <script>
        window.twttr = (function (d, s, id) {
            var t, js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s);
            js.id = id;
            js.src = "https://platform.twitter.com/widgets.js";
            fjs.parentNode.insertBefore(js, fjs);
            return window.twttr || (t = { _e: [], ready: function (f) {
                t._e.push(f)
            } });
        }(document, "script", "twitter-wjs"));
    </script>

    <script>

        var timeouts = [];

        function hashTagSearch() {
            query = "";
            if (document.note.hashtag.value[0] != '#') {
                query = "#"
            }
            query = query + document.note.hashtag.value;

            /*
             iframe_url = "http://" + window.location.hostname + ":" + window.location.port + "/search?q=" + encodeURIComponent(query);
             document.getElementById("search").src = iframe_url;
             #window.frames["search"].location.href = iframe_url;
             frames[1].location.href = iframe_url;
             */

            startstream(query)
        }
        function noteit() {
            document.note.composed.value = document.note.speakertwitter.value + ": " + document.note.quote.value + " " + document.note.hashtag.value;
            document.getElementById("charcount").innerHTML = document.note.composed.value.length;
        }
        function getSpeakerHTML() {
            return "<a href='" + document.note.speakerurl.value + "'>" + document.note.speakername.value + '</a>: ';
        }
        function postit() {
            document.note.archive.value = document.note.archive.value + "\n" + document.note.composed.value;
            document.note.blogpost.value = document.note.blogpost.value + "\n<p>" + getSpeakerHTML() + document.note.quote.value;
            document.getElementById("preview").innerHTML = document.note.blogpost.value;
            document.getElementById("tweet").src = '/sendtweet?status=' + escape(document.note.composed.value);
            document.note.quote.value = "";

        }

        function changespeakerinfo() {
            handle = document.note.speakerhandle.value;
            req = new XMLHttpRequest();
            req.onreadystatechange = function () {
                foundspeaker();
            };
            req.open("GET", '/lookupspeaker?handle=' + handle, true);
            req.send(null);
            document.note.speakertwitter.value = '@' + handle;
        }

        function foundspeaker() {
            // only if req is "loaded"
            if (req.readyState == 4) {
                // only if "OK"
                if (req.status == 200 || req.status == 304) {
                    //document.getElementById('error').innerHTML=req.responseText;
                    speaker = JSON.parse(req.responseText);
                    // document.note.speakertwitter.value = speaker.twitter;
                    document.note.speakerurl.value = speaker.url;
                    document.note.speakername.value = speaker.name;
                } else {
                    document.getElementById('error').innerHTML = "ahah error:\n" +
                            req.statusText;
                }
            }
        }

        function startstream(query) {
            for (var i = 0; i < timeouts.length; i++) {
                clearInterval(timeouts[i]);
            }

            timeouts = [];

            req = new XMLHttpRequest();
            req.onreadystatechange = function () {
                updatelatesttweets();
            };
            req.open("GET", '/stream?q=' + encodeURIComponent(query), true);
            req.send(null);
            console.log("starting stream");
            timeouts.push(setInterval(getlatesttweets, 5000));
        }

        function getlatesttweets() {
            query = "";
            if (document.note.hashtag.value[0] != '#') {
                query = "#"
            }
            query = query + document.note.hashtag.value;

            req = new XMLHttpRequest();
            req.onreadystatechange = function () {
                updatelatesttweets();
            };
            req.open("GET", '/poll?q=' + encodeURIComponent(query), false);
            req.send(null);
            // console.log("getting tweets");
        }


        function updatelatesttweets() {
            document.getElementById('error').innerHTML = "";
            if (req.readyState == 4) {
                // only if "OK"
                if (req.status == 200 || req.status == 304) {
                    //document.getElementById('error').innerHTML=req.responseText;
                    messages = JSON.parse(req.responseText);

                    //
                    tweets = "";

                    tweet_obj = Array.prototype.slice.call(document.getElementById('latesttweets').children);
                    if (tweet_obj.length > 9)
                        tweet_obj.splice(9, tweet_obj.length - 1)
                    tweet_obj.forEach(function (elem, itt) {
                        tweets = tweets + elem.outerHTML;
                    });


                    messages.forEach(function (status, itt) {
                        date = new Date(status.created_at);
                        twdate = date.toDateString();

                        if ('undefined' !== typeof status.disconnect
                                || 'undefined' !== typeof status.warning)
                            return;

                        tweet = '<div><blockquote class="twitter-tweet" data-conversation="none" data-cards="hidden" width="400"><p>' + status.text + '</p>' +
                                '&mdash; <a href="https://twitter.com/' +
                                status.user.screen_name + '" target="_new">' + status.user.name + '</a> (@' + status.user.screen_name + ') <a href="https://twitter.com/' +
                                status.user.screen_name + '/statuses/' + status.id_str + '" target="_new">' + twdate + '</a></blockquote></div>';

                        tweets = tweet + tweets;
                    });
                    if (tweets != "") {
                        document.getElementById('latesttweets').innerHTML = tweets;
                        obj = Array.prototype.slice.call(document.getElementById('latesttweets').children);
                        obj.forEach(function (elem, itt) {
                            elem.onclick = function (e) {
                                interestingtweets = document.getElementById("interestingtweets");
                                interestingtweets.insertBefore(this, interestingtweets.firstChild);
                                twttr.widgets.load(interestingtweets.firstChild);
                                if (interestingtweets.children.length > 5)
                                    interestingtweets.removeChild(interestingtweets.lastChild);
                            }
                        });
                    }

                } else {
                    document.getElementById('error').innerHTML = "ahah error:\n" +
                            req.statusText;
                }
            }
        }
    </script>

    <style type='text/css'>

        .row {
            padding-bottom: 15px;
        }
    </style>

</head>
<body onload="hashTagSearch();">
<div class='container'>
    <div class="navbar">
        <div class="container">
            <h1><a class='navbar-brand' href="#">Noter Live</a></h1>
            <a class='btn btn-info pull-right' href="/auth/twitter">Login with Twitter</a>
        </div>
        <div id="error" class="alert-danger"></div>
    </div>


    <form name="note" class='form-inline'>
        <div class='row'>
            <div class="col col-lg-12">
                <div class='input-group '>
                    <span class="input-group-addon input">#</span>
                    <input type='text' name="hashtag" value="#food" onchange="hashTagSearch();">
                </div>
            </div>
        </div>
        <input name="speakerhandle" value="waxpancake" type="text">
        <input type="button" class="btn" value="Change Speaker" onclick="changespeakerinfo()">

        <div class='row'>
            <div class='col col-lg-4'>
                <div class='input-group'>
                    <span class="input-group-addon input">@</span>
                    <input name="speakertwitter" value="@webhat" type='text'/>
                </div>
            </div>
            <div class='col col-lg-4'>
                <input name="speakername" value="" type='text'/>
            </div>
            <div class='col col-lg-4'>
                <input type='text' name="speakerurl" value="">
            </div>
        </div>
        <div class='row'>
            <div class='col col-lg-12'>
                <div class='input-group'>
                    <input type="search" name="quote" placeholder="type the speaker's brilliant quote here"
                           oninput="noteit()" onchange="noteit()"
                           onkeydown="if (event.keyCode == 13) { postit(); return false; }">
              <span class="input-group-btn">
                <input type="button" class='btn btn-default' value="Note" onclick="postit()">
              </span>
                </div>
            </div>
        </div>
        <div class='row'>
            <div class='col col-lg-12'>
                <textarea id="composed"></textarea>
                <span class='label' id="charcount">0</span>
            </div>
        </div>
        <div class='row'>
            <div class='col col-lg-12'>
                <textarea id="archive"></textarea>
            </div>
        </div>
        <div class='row'>
            <div class='col col-lg-12'>
                <textarea id="blogpost"></textarea>
            </div>
        </div>
    </form>
    <div id="preview"></div>
    <div class="row">
        <div class="col col-4">
            <iframe id="tweet" src="/showuser" seamless></iframe>
            <div id="interestingtweets"></div>
        </div>
        <div id="latesttweets" class="col col-8"></div>
    </div>
    <!--iframe id="search" src="" width="1200" height="800" seamless></iframe-->
</div>


<footer class='well'>
    <p>
        A web app to make live note posting (aka live-tweeting, live-blogging) easier. By Kevin Marks.
        Currently semi-functional, but less ugly thanks to Frédéric de Villamil.
        <a href="https://github.com/kevinmarks/noterlive">Original code here</a>.
    </p>

    <p>
        Update by Dani&euml;l W. Crompton
        <a href="https://github.com/webhat/noterlive">Code here</a>.
    </p>
</footer>

</body>
</html>